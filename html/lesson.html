<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø±Ø³ - ØªØ¹Ù„Ù… Ù…Ø¹Ù†Ø§</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.location.href='lessons.html'">
                â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø±ÙˆØ³
            </button>
            <div class="stars">
                â­ <span id="totalStars">0</span>
            </div>
        </div>

        <div class="lesson-container">
            <div class="lesson-header">
                <div class="lesson-emoji" id="lessonEmoji">ğŸ“š</div>
                <h2 id="lessonTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <p id="lessonDescription"></p>
            </div>

            <div class="video-container">
                <iframe 
                    id="lessonVideo"
                    src="" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>

            <div class="quiz-section">
                <h3>ğŸ¯ Ø§Ù„Ø¢Ù† Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h3>
                <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                    Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ
                </p>
                <div id="quizContainer">
                    <!-- Quiz questions will be populated here -->
                </div>
                <button class="submit-quiz-btn" id="submitQuiz" disabled>
                    âœ“ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="celebration">ğŸ‰</div>
            <h2>Ø£Ø­Ø³Ù†Øª! ğŸŒŸ</h2>
            <p style="font-size: 1.5rem; margin: 1rem 0;">
                Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­!
            </p>
            <p style="font-size: 1.2rem; color: #4CAF50;">
                Ø­ØµÙ„Øª Ø¹Ù„Ù‰ <strong id="earnedStars">0</strong> Ù†Ø¬Ù…Ø©! â­
            </p>
            <button class="next-lesson-btn" onclick="goToNextLesson()">
                â†’ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
            <button class="next-lesson-btn" style="background: #6c757d; margin-right: 1rem;" onclick="window.location.href='lessons.html'">
                Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø±ÙˆØ³
            </button>
        </div>
    </div>

    <script src="../data.js"></script>
    <script>
        let currentLesson = null;
        let userAnswers = [];

        // Get lesson ID from URL
        function getLessonIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return parseInt(urlParams.get('id')) || 1;
        }

        // Load progress
        function getProgress() {
            const progress = localStorage.getItem('lessonsProgress');
            return progress ? JSON.parse(progress) : { completed: [], totalStars: 0 };
        }

        function saveProgress(lessonId, starsEarned) {
            const progress = getProgress();
            
            if (!progress.completed.includes(lessonId)) {
                progress.completed.push(lessonId);
                progress.totalStars += starsEarned;
                localStorage.setItem('lessonsProgress', JSON.stringify(progress));
            }
        }

        // Update stars display
        function updateStarsDisplay() {
            const progress = getProgress();
            document.getElementById('totalStars').textContent = progress.totalStars;
        }

        // Load lesson content
        function loadLesson() {
            const lessonId = getLessonIdFromUrl();
            currentLesson = getLessonById(lessonId);

            if (!currentLesson) {
                alert('Ø§Ù„Ø¯Ø±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                window.location.href = 'lessons.html';
                return;
            }

            // Update lesson info
            document.getElementById('lessonEmoji').textContent = currentLesson.emoji;
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            document.getElementById('lessonDescription').textContent = currentLesson.description;
            document.getElementById('lessonVideo').src = currentLesson.videoUrl;

            // Load quiz
            loadQuiz();
        }

        // Load quiz questions
        function loadQuiz() {
            const quizContainer = document.getElementById('quizContainer');
            userAnswers = new Array(currentLesson.quiz.length).fill(null);

            currentLesson.quiz.forEach((question, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.id = `question-${qIndex}`;

                const questionText = document.createElement('div');
                questionText.className = 'question-text';
                questionText.textContent = `${qIndex + 1}. ${question.question}`;
                questionDiv.appendChild(questionText);

                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'choices';

                question.choices.forEach((choice, cIndex) => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.className = 'choice-btn';
                    choiceBtn.textContent = choice;
                    choiceBtn.onclick = () => selectAnswer(qIndex, cIndex, choiceBtn);
                    choicesDiv.appendChild(choiceBtn);
                });

                questionDiv.appendChild(choicesDiv);
                quizContainer.appendChild(questionDiv);
            });
        }

        // Handle answer selection
        function selectAnswer(questionIndex, choiceIndex, button) {
            // Remove selected class from all choices in this question
            const questionDiv = document.getElementById(`question-${questionIndex}`);
            const allChoices = questionDiv.querySelectorAll('.choice-btn');
            allChoices.forEach(btn => btn.classList.remove('selected'));

            // Add selected class to clicked button
            button.classList.add('selected');

            // Store user answer
            userAnswers[questionIndex] = choiceIndex;

            // Enable submit button if all questions answered
            checkAllAnswered();
        }

        // Check if all questions are answered
        function checkAllAnswered() {
            const allAnswered = userAnswers.every(answer => answer !== null);
            document.getElementById('submitQuiz').disabled = !allAnswered;
        }

        // Submit quiz
        document.getElementById('submitQuiz').onclick = function() {
            let allCorrect = true;
            let correctCount = 0;

            currentLesson.quiz.forEach((question, index) => {
                const questionDiv = document.getElementById(`question-${index}`);
                const isCorrect = userAnswers[index] === question.correctAnswer;

                if (isCorrect) {
                    questionDiv.classList.add('correct');
                    questionDiv.classList.remove('incorrect');
                    correctCount++;
                } else {
                    questionDiv.classList.add('incorrect');
                    questionDiv.classList.remove('correct');
                    allCorrect = false;
                }

                // Disable all buttons
                const choices = questionDiv.querySelectorAll('.choice-btn');
                choices.forEach(btn => btn.disabled = true);
            });

            if (allCorrect) {
                // Calculate stars (3 stars per lesson)
                const starsEarned = 3;
                
                // Save progress
                saveProgress(currentLesson.id, starsEarned);

                // Create confetti effect
                createConfetti();

                // Show success modal
                setTimeout(() => {
                    document.getElementById('earnedStars').textContent = starsEarned;
                    document.getElementById('successModal').classList.add('show');
                    updateStarsDisplay();
                }, 1000);
            } else {
                alert('âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                
                // Reset for retry
                setTimeout(() => {
                    currentLesson.quiz.forEach((question, index) => {
                        const questionDiv = document.getElementById(`question-${index}`);
                        questionDiv.classList.remove('correct', 'incorrect');
                        const choices = questionDiv.querySelectorAll('.choice-btn');
                        choices.forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('selected');
                        });
                    });
                    
                    userAnswers = new Array(currentLesson.quiz.length).fill(null);
                    document.getElementById('submitQuiz').disabled = true;
                }, 2000);
            }
        };

        // Create confetti effect
        function createConfetti() {
            const colors = ['ğŸ‰', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸŠ'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.textContent = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.position = 'fixed';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-50px';
                    confetti.style.fontSize = '2rem';
                    confetti.style.animation = 'confetti-fall 3s linear';
                    confetti.style.pointerEvents = 'none';
                    confetti.style.zIndex = '9999';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // Go to next lesson
        function goToNextLesson() {
            const nextLessonId = currentLesson.id + 1;
            const nextLesson = getLessonById(nextLessonId);

            if (nextLesson) {
                window.location.href = `lesson.html?id=${nextLessonId}`;
            } else {
                alert('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³!');
                window.location.href = 'lessons.html';
            }
        }

        // Initialize
        updateStarsDisplay();
        loadLesson();
    </script>
</body>
</html>